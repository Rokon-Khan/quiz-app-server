// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 1. Users
model User {
  id                String         @id @default(uuid())
  email             String         @unique
  password_hash     String
  full_name         String
  avatar_url        String?
  role              String         @default("user")
  is_active         Boolean        @default(true)
  created_at        DateTime       @default(now())
  updated_at        DateTime       @default(now())
  
  // Relations
  quiz_attempts     UserQuizAttempt[]
  progress          UserProgress[]
  certificates      Certificate[]
}

// 2. Categories
model Category {
  id              String         @id @default(uuid())
  name            String         @unique
  description     String?
  icon_url        String?
  display_order   Int            @default(0)
  is_active       Boolean        @default(true)
  created_at      DateTime       @default(now())
  
  // Relations
  quizzes         Quiz[]
}

// 3. Quizzes
model Quiz {
  id                    String         @id @default(uuid())
  category_id           String
  title                 String
  description           String?
  thumbnail_url         String?
  difficulty_level      String         @default("medium")
  questions_per_attempt Int            @default(10)
  time_limit_minutes    Int            @default(0)
  passing_score         Int            @default(70)
  is_published          Boolean        @default(false)
  created_at            DateTime       @default(now())
  updated_at            DateTime       @default(now())
  
  // Relations
  category              Category       @relation(fields: [category_id], references: [id], onDelete: Cascade)
  questions             Question[]
  attempts              UserQuizAttempt[]
  progress              UserProgress[]
  certificates          Certificate[]
}

// 4. Questions
model Question {
  id                String         @id @default(uuid())
  quiz_id           String
  question_type     String         // 'multiple_choice', 'checkbox', 'yes_no'
  question_text     String
  question_image_url String?
  points            Int            @default(1)
  display_order     Int            @default(0)
  metadata          Json           @default("{}")
  created_at        DateTime       @default(now())
  updated_at        DateTime       @default(now())
  
  // Relations
  quiz                Quiz           @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  options             AnswerOption[]
  fun_facts           FunFact[]
  user_answers        UserAnswer[]
}

// 5. Answer Options
model AnswerOption {
  id              String         @id @default(uuid())
  question_id     String
  option_text     String?
  option_image_url String?
  is_correct      Boolean        @default(false)
  display_order   Int            @default(0)
  created_at      DateTime       @default(now())
  
  // Relations
  question        Question       @relation(fields: [question_id], references: [id], onDelete: Cascade)
}

// 6. Fun Facts
model FunFact {
  id              String         @id @default(uuid())
  question_id     String
  title           String?
  content         String
  image_url       String?
  created_at      DateTime       @default(now())
  
  // Relations
  question        Question       @relation(fields: [question_id], references: [id], onDelete: Cascade)
}

// 7. User Quiz Attempts
model UserQuizAttempt {
  id                String         @id @default(uuid())
  user_id           String
  quiz_id           String
  score             Int            @default(0)
  total_questions   Int
  correct_answers   Int            @default(0)
  time_taken_seconds Int           @default(0)
  status            String         @default("in_progress")
  started_at        DateTime       @default(now())
  completed_at      DateTime?
  
  // Relations
  user              User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  quiz              Quiz           @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  answers           UserAnswer[]
}

// 8. User Answers
model UserAnswer {
  id              String         @id @default(uuid())
  attempt_id      String
  question_id     String
  selected_options Json           // Array of option IDs
  is_correct      Boolean        @default(false)
  points_earned   Int            @default(0)
  answered_at     DateTime       @default(now())
  
  // Relations
  attempt         UserQuizAttempt @relation(fields: [attempt_id], references: [id], onDelete: Cascade)
  question        Question       @relation(fields: [question_id], references: [id], onDelete: Cascade)
}

// 9. User Progress
model UserProgress {
  id                String         @id @default(uuid())
  user_id           String
  quiz_id           String
  total_attempts    Int            @default(0)
  best_score        Int            @default(0)
  total_time_spent  Int            @default(0)
  last_attempt_at   DateTime?
  created_at        DateTime       @default(now())
  
  // Relations
  user              User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  quiz              Quiz           @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, quiz_id])
}

// 10. Certificates
model Certificate {
  id              String         @id @default(uuid())
  user_id         String
  quiz_id         String
  certificate_url String
  score_achieved  Int
  issued_at       DateTime       @default(now())
  
  // Relations
  user              User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  quiz              Quiz           @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, quiz_id])
}